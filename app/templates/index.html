<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lentivirus Production Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="app">
<header class="top-bar">
    <div class="brand">
        <span class="brand-mark">LT</span>
        <div>
            <h1>Lentivirus Production Tracker</h1>
            <p class="brand-subtitle">Workspace for planning, producing, and titering lentivirus.</p>
        </div>
    </div>
    <div class="top-actions">
        <button id="createExperimentButton" class="primary">New experiment</button>
    </div>
</header>
<main class="main">
    <section id="dashboardView" class="view active">
        <div id="newExperimentPanel" class="panel" hidden>
            <header class="panel-header">
                <h2>Create experiment</h2>
                <button class="ghost" type="button" id="closeExperimentPanel">Close</button>
            </header>
            <form id="newExperimentForm" class="form-grid">
                <div class="form-group">
                    <label for="experimentName">Experiment name</label>
                    <input id="experimentName" name="name" type="text" placeholder="e.g. GFP lentivirus batch">
                </div>
                <div class="form-group">
                    <label for="experimentCellLine">Cell line</label>
                    <select id="experimentCellLine" name="cell_line">
                        <option value="HEK293T">HEK293T</option>
                        <option value="HEK293FT">HEK293FT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="experimentCells">Cells to seed</label>
                    <input id="experimentCells" name="cells_to_seed" type="text" placeholder="e.g. 15M or 750K" required>
                    <span class="hint">Shorthand like 750K or 1.5M is supported.</span>
                </div>
                <div class="form-group">
                    <label for="experimentVessel">Vessel type</label>
                    <select id="experimentVessel" name="vessel_type">
                        {% for vessel, area in surface_areas.items() %}
                        <option value="{{ vessel }}">{{ vessel }} ({{ area }} cm²)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="experimentVesselsSeeded"># of vessels seeded</label>
                    <input id="experimentVesselsSeeded" name="vessels_seeded" type="number" min="1" value="1">
                </div>
                <div class="form-group">
                    <label for="experimentMedia">Media type</label>
                    <input id="experimentMedia" name="media_type" type="text" value="{{ default_media }}">
                </div>
                <div class="form-group">
                    <label for="experimentDate">Seeding date</label>
                    <input id="experimentDate" name="seeding_date" type="date" value="{{ today }}">
                </div>
                <div class="form-actions">
                    <button class="primary" type="submit">Save</button>
                    <button class="ghost" type="button" id="cancelExperimentForm">Cancel</button>
                </div>
            </form>
        </div>
        <section class="experiment-section">
            <header class="section-header">
                <h2>Active experiments</h2>
                <p>Active experiments for lentivirus production. Mark experiments finished once viral harvest and titering are complete.</p>
            </header>
            <div id="activeExperiments" class="card-grid"></div>
        </section>
        <section class="experiment-section">
            <header class="section-header">
                <h2>Finished experiments</h2>
                <p>Review historical batches or reopen to continue processing.</p>
            </header>
            <div id="finishedExperiments" class="card-grid muted"></div>
        </section>
    </section>
    <section id="workflowView" class="view" hidden>
        <div class="workflow-header">
            <button id="backToDashboard" class="ghost">Back to experiments</button>
            <div class="workflow-title">
                <h1 id="workflowExperimentName">Experiment</h1>
                <p id="workflowExperimentMeta"></p>
            </div>
            <div class="workflow-actions">
                <button id="renameExperiment" class="ghost">Rename</button>
                <button id="toggleExperimentStatus" class="ghost"></button>
                <button id="deleteExperiment" class="ghost danger">Delete</button>
            </div>
        </div>
        <div class="workflow-columns">
            <section class="card" id="seedingCard">
                <header class="card-header">
                    <h2>1 · Cell seeding</h2>
                    <p>Update vessels, counts, and media for the experiment.</p>
                </header>
                <form id="seedingDetailForm" class="form-grid compact seeding-grid">
                    <div class="form-group">
                        <label for="detailName">Experiment name</label>
                        <input id="detailName" name="name" type="text">
                    </div>
                    <div class="form-group">
                        <label for="detailCellLine">Cell line</label>
                        <select id="detailCellLine" name="cell_line">
                            <option value="HEK293T">HEK293T</option>
                            <option value="HEK293FT">HEK293FT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="detailCells">Cells to seed</label>
                        <input id="detailCells" name="cells_to_seed" type="text" required>
                    </div>
                    <div class="form-group">
                        <label for="detailVessel">Vessel type</label>
                        <select id="detailVessel" name="vessel_type">
                            {% for vessel, area in surface_areas.items() %}
                            <option value="{{ vessel }}">{{ vessel }} ({{ area }} cm²)</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="detailVesselsSeeded"># of vessels seeded</label>
                        <input id="detailVesselsSeeded" name="vessels_seeded" type="number" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="detailMedia">Media type</label>
                        <input id="detailMedia" name="media_type" type="text">
                    </div>
                    <div class="form-group">
                        <label for="detailDate">Seeding date</label>
                        <input id="detailDate" name="seeding_date" type="date">
                    </div>
                    <div class="form-actions">
                        <button class="primary" type="submit">Save changes</button>
                    </div>
                </form>
                <dl class="meta" id="seedingMeta"></dl>
            </section>
            <section class="card" id="prepCard">
                <header class="card-header">
                    <h2>2 · Lentivirus preparations</h2>
                    <p>Assign transfer plasmids to seeded plates, manage plate counts, and monitor downstream status.</p>
                </header>
                <div id="prepCapacity" class="callout muted"></div>
                <form id="prepForm" class="form-grid compact">
                    <div class="form-group">
                        <label for="transferName">Transfer plasmid</label>
                        <input id="transferName" type="text" required placeholder="e.g. pLenti-GFP">
                    </div>
                    <div class="form-group">
                        <label for="transferConcentration">Concentration (ng/µL)</label>
                        <input id="transferConcentration" type="number" step="any" placeholder="e.g. 450">
                    </div>
                    <div class="form-group">
                        <label for="plasmidSize">Plasmid size (bp)</label>
                        <input id="plasmidSize" type="number" step="1" placeholder="e.g. 9500">
                    </div>
                    <div class="form-group">
                        <label for="plateCountInput">Plates</label>
                        <input id="plateCountInput" type="number" min="1" value="1">
                    </div>
                    <div class="form-actions">
                        <button class="primary" type="submit">Save preparation</button>
                    </div>
                </form>
                <div id="prepError" class="callout danger" hidden></div>
                <div class="prep-toolbar">
                    <div class="toolbar-actions">
                        <button type="button" class="ghost small" id="selectAllPreps">Select all</button>
                        <button type="button" class="ghost small" id="clearSelectedPreps">Clear</button>
                    </div>
                    <span id="prepSelectionSummary" class="muted"></span>
                </div>
                <div class="table-wrapper">
                    <table class="prep-table">
                        <thead>
                            <tr>
                                <th scope="col"></th>
                                <th scope="col">Preparation</th>
                                <th scope="col">Transfer conc. (ng/µL)</th>
                                <th scope="col">Plasmid size (bp)</th>
                                <th scope="col">Plates</th>
                                <th scope="col">Status</th>
                                <th scope="col" class="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prepTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section class="card" id="transfectionCard">
                <header class="card-header">
                    <h2>3 · Transfection</h2>
                    <p>Scaling uses the seeded vessel. Provide plasmid concentrations to compute volumes and update prep status.</p>
                </header>
                <div id="transfectionSection" class="workflow-section">
                    <div id="transfectionPlaceholder" class="callout muted">Select one or more preparations to configure transfection.</div>
                    <div id="transfectionBulkControls" class="bulk-controls" hidden>
                        <div class="control-group">
                            <label>Packaging concentration (ng/µL)
                                <input type="number" step="any" id="bulkPackagingInput">
                            </label>
                            <label>Envelope concentration (ng/µL)
                                <input type="number" step="any" id="bulkEnvelopeInput">
                            </label>
                            <button type="button" class="ghost small" id="applyTransfectionBulk">Apply to all rows</button>
                        </div>
                    </div>
                    <div class="table-wrapper" id="transfectionTableWrapper" hidden>
                        <table class="workflow-table" id="transfectionTable">
                            <thead>
                                <tr>
                                    <th scope="col">Preparation</th>
                                    <th scope="col">Molar ratio</th>
                                    <th scope="col">Transfer (ng/µL)</th>
                                    <th scope="col">Packaging (ng/µL)</th>
                                    <th scope="col">Envelope (ng/µL)</th>
                                    <th scope="col">Volumes to add (µL)</th>
                                    <th scope="col" class="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="transfectionActions" class="form-actions" hidden>
                        <button type="button" class="ghost" id="copyTransfectionLabels">Copy all labels</button>
                        <button type="button" class="primary" id="saveTransfection">Save transfection</button>
                    </div>
                    <div id="transfectionError" class="callout danger" hidden></div>
                </div>
            </section>
            <section class="card" id="mediaCard">
                <header class="card-header">
                    <h2>4 · Media change</h2>
                    <p>Log the media and volume for individual or bulk updates. Saving updates each prep status.</p>
                </header>
                <div id="mediaSection" class="workflow-section">
                    <div id="mediaPlaceholder" class="callout muted">Select preparations that have been transfected to log media changes.</div>
                    <div id="mediaBulkControls" class="bulk-controls" hidden>
                        <div class="control-group">
                            <label>Media
                                <select id="mediaBulkSelect">
                                    <option value="DMEM + 10% FBS">DMEM + 10% FBS</option>
                                    <option value="DMEM + 10% iFBS">DMEM + 10% iFBS</option>
                                    <option value="DMEM + 20% iFBS">DMEM + 20% iFBS</option>
                                    <option value="other">Other…</option>
                                </select>
                            </label>
                            <label id="mediaBulkOtherWrapper" class="other-input" hidden>Custom media
                                <input type="text" id="mediaBulkOther">
                            </label>
                            <label>Volume (mL)
                                <input type="number" step="any" min="0" id="mediaBulkVolume">
                            </label>
                            <button type="button" class="ghost small" id="applyMediaBulk">Apply to all rows</button>
                        </div>
                    </div>
                    <div id="mediaEntries" class="stack" hidden></div>
                    <div id="mediaActions" class="form-actions" hidden>
                        <button type="button" class="primary" id="saveMediaChanges">Save media change</button>
                    </div>
                    <div id="mediaError" class="callout danger" hidden></div>
                </div>
            </section>
            <section class="card" id="harvestCard">
                <header class="card-header">
                    <h2>5 · Viral harvest</h2>
                    <p>Log harvest dates and volumes. Labels omit extra prefixes and copy in one click.</p>
                </header>
                <div id="harvestSection" class="workflow-section">
                    <div id="harvestPlaceholder" class="callout muted">Select preparations with media changes to log harvests.</div>
                    <div id="harvestEntries" class="stack" hidden></div>
                    <div id="harvestActions" class="form-actions" hidden>
                        <button type="button" class="ghost" id="copyHarvestLabels">Copy all labels</button>
                        <button type="button" class="primary" id="saveHarvests">Save harvest</button>
                    </div>
                    <div id="harvestError" class="callout danger" hidden></div>
                </div>
            </section>
            <section class="card" id="titerSetupCard">
                <header class="card-header">
                    <h2>6 · Lentivirus titering setup</h2>
                    <p>Plan infection tests, selection conditions, and bulk apply wells for multiple preparations.</p>
                </header>
                <div id="titerSetupSection" class="workflow-section">
                    <div id="titerSetupPlaceholder" class="callout muted">Select harvested preparations to configure titering.</div>
                    <form id="titerSetupForm" class="form-grid compact" hidden>
                        <div class="form-group">
                            <label for="titerCellLine">Cell line for infection</label>
                            <input id="titerCellLine" type="text" placeholder="e.g. HEK293T" required>
                        </div>
                        <div class="form-group">
                            <label for="titerVessel">Vessel type</label>
                            <select id="titerVessel">
                                <option value="6-well">6-well</option>
                                <option value="96-well">96-well</option>
                                <option value="48-well">48-well</option>
                                <option value="24-well">24-well</option>
                                <option value="12-well">12-well</option>
                                <option value="10 cm dish">10 cm dish</option>
                                <option value="15 cm dish">15 cm dish</option>
                                <option value="T25">T25</option>
                                <option value="T75">T75</option>
                                <option value="T175">T175</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="selectionReagent">Selection reagent</label>
                            <select id="selectionReagent">
                                <option value="Puromycin">Puromycin</option>
                                <option value="Blasticidin">Blasticidin</option>
                                <option value="Hygromycin">Hygromycin</option>
                                <option value="Other">Other…</option>
                            </select>
                        </div>
                        <div class="form-group" id="selectionOtherGroup" hidden>
                            <label for="selectionOtherInput">Custom selection reagent</label>
                            <input id="selectionOtherInput" type="text" placeholder="Enter reagent name" disabled>
                        </div>
                        <div class="form-group">
                            <label for="selectionConcentration">Selection concentration (µg/mL)</label>
                            <input id="selectionConcentration" type="number" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="polybreneInput">Polybrene (µg/mL)</label>
                            <input id="polybreneInput" type="number" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="testsCount">Number of test concentrations</label>
                            <input id="testsCount" type="number" min="1" value="1">
                        </div>
                        <div class="form-group">
                            <label for="titerNotes">Notes</label>
                            <textarea id="titerNotes" rows="2" placeholder="Any additional context"></textarea>
                        </div>
                    </form>
                    <div id="titerPrepTableWrapper" class="table-wrapper" hidden>
                        <table class="workflow-table" id="titerPrepTable">
                            <thead>
                                <tr>
                                    <th scope="col">Preparation</th>
                                    <th scope="col">Cells seeded</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="titerSampleBuilder" class="stack" hidden>
                        <header class="stack-header">Virus volumes per condition</header>
                        <div id="titerSamples"></div>
                    </div>
                    <div id="titerSetupActions" class="form-actions" hidden>
                        <div class="scope-controls">
                            <label for="titerSaveScope">Save plan for</label>
                            <select id="titerSaveScope">
                                <option value="all">All selected</option>
                                <option value="single">Single preparation</option>
                            </select>
                            <select id="titerSaveTarget" hidden aria-label="Preparation to apply plan to"></select>
                        </div>
                        <button type="button" class="ghost" id="copyTiterPlanLabels" hidden>Copy plan labels</button>
                        <button type="button" class="ghost" id="generateTiterSamples">Generate wells</button>
                        <button type="button" class="primary" id="saveTiterSetup">Save titer plan</button>
                    </div>
                    <div id="titerSetupError" class="callout danger" hidden></div>
                    <div id="titerRunsContainer" class="stack" hidden></div>
                </div>
            </section>
            <section class="card" id="titerResultsCard">
                <header class="card-header">
                    <h2>7 · Record results & calculate titer</h2>
                    <p>Enter control-normalised concentrations to compute survival, MOI, and titers with rounded summaries.</p>
                </header>
                <div id="titerResultsSection" class="workflow-section">
                    <div id="titerRunSelector" hidden>
                        <label for="titerRunSelect">Titer run</label>
                        <select id="titerRunSelect"></select>
                    </div>
                    <div id="titerResultsPlaceholder" class="callout muted">Select a titer run from the setup list.</div>
                    <form id="titerResultsForm" class="form-grid compact" hidden>
                        <div class="form-group">
                            <label for="resultsMeasurementVolume">Measurement media volume (mL)</label>
                            <input id="resultsMeasurementVolume" type="number" step="any" min="0">
                        </div>
                        <div class="form-group">
                            <label for="resultsControlConcentration">Control cell concentration (cells/mL)</label>
                            <input id="resultsControlConcentration" type="text" placeholder="No LV - Selection">
                        </div>
                        <div id="resultsSamples"></div>
                        <div class="form-actions">
                            <button class="primary" type="submit">Save titer results</button>
                        </div>
                        <div class="titer-summary" id="titerSummary"></div>
                        <button id="copyTiterSummary" type="button" class="ghost small" hidden>Copy summary</button>
                    </form>
                </div>
            </section>
        </div>
    </section>
</main>
<script>
    const APP_DEFAULT_MEDIA = "{{ default_media }}";
    const APP_SURFACE_AREAS = {{ surface_areas | tojson }};
</script>
<script src="{{ url_for('static', filename='js/app.js') }}" defer></script>
</body>
</html>
